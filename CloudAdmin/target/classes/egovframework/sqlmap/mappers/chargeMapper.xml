<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.hivesys.charge.mapper.ChargeMapper">
<!-- 
수정일           수정자         수정내용 
========= ======= ================================================= 
2020.07.23 정다빈     최초 생성 
-->

<!-- 고객과금 -->

	<select id="selectPriceList" parameterType="chargeVo" resultType="chargeVo">
		SELECT 
		CONCAT(J1.COMPANY_ID,"-",DATE_FORMAT(J1.REG_DT, '%Y%m%d'),"-",J2.SERVICE_TYPE) AS CHARGE_ID
		,ABS(DATEDIFF(BILL_DT,DUE_DATE))+1 AS USE_DT
		,J1.*,J2.* 
		
		FROM
		(
			SELECT 
			 A.COMPANY_ID
			,A.COMPANY_NAME
			,A.BILL_DT
			,A.BILL_RFDT
			,A.BR_NUMBER
			,LAST_DAY(BILL_RFDT+ INTERVAL 1 MONTH) AS DUE_DATE
			
			,A.MSP_NHN
			,A.MSP_NAVER
			,A.MSP_KT
			,A.MSP_AWS
			,A.MSP_RESALE
			,A.IAAS_NHN
			,A.IAAS_NAVER
			,A.IAAS_KT
			,A.IAAS_AWS
			,A.SDR_NHN
			,A.SDR_NAVER
			,A.SDR_KT
			
			,B.MSP_PRICE
			,B.IAAS_PRICE
			,B.DATADR_PRICE
			,B.PRICE_TYPE
			,B.SUM_PRICE
			
			,A.COMPANY_ID AS TID
			,A.REG_DT
			FROM 
			company_info A
			LEFT JOIN
			charge_info B
			ON (A.COMPANY_ID=B.COMPANY_ID)
		)J1
		RIGHT JOIN
		(
			SELECT mp.*, danga*buy_cnt AS PRE_PRICE 
			from
			(
				SELECT 
				mm.*,
				case 
					when service_type=0 then 150000
					when service_type=1 then 250000
					ELSE 350000 END AS danga
				FROM 
				msp_charge mm
			)mp		
		)J2
		ON(J1.TID=J2.COMPANY_ID)
		
		WHERE 1=1
		AND
		(
			( J1.IAAS_NHN    ='Y'
				OR J1.IAAS_NAVER  ='Y'
				OR J1.IAAS_KT     ='Y'
				OR J1.IAAS_AWS    ='Y'
			)
			OR
			 (J1.SDR_NHN     ='Y'
				OR J1.SDR_NAVER   ='Y'
				OR J1.SDR_KT      ='Y'
			)
		)
	</select>
	
	<insert id="chargeInsert" parameterType="chargeVo">
	    INSERT INTO CHARGE_INFO
		SELECT 
		CONCAT(J1.COMPANY_ID,"-",DATE_FORMAT(J1.REG_DT, '%Y%m%d'),"-",J2.SERVICE_TYPE) AS CHARGE_ID
			,J1.COMPANY_ID
			,J2.SERVICE_TYPE
			,J1.MSP_PRICE
			,J1.IAAS_PRICE
			,J1.DATADR_PRICE
		FROM
		(
			SELECT 
			 A.COMPANY_ID
			,A.COMPANY_NAME
			,A.BILL_DT
			,A.BILL_RFDT
			,A.BR_NUMBER
			,LAST_DAY(BILL_RFDT+ INTERVAL 1 MONTH) AS DUE_DATE
			
			,A.MSP_NHN
			,A.MSP_NAVER
			,A.MSP_KT
			,A.MSP_AWS
			,A.MSP_RESALE
			,A.IAAS_NHN
			,A.IAAS_NAVER
			,A.IAAS_KT
			,A.IAAS_AWS
			,A.SDR_NHN
			,A.SDR_NAVER
			,A.SDR_KT
			
			,B.MSP_PRICE
			,B.IAAS_PRICE
			,B.DATADR_PRICE
			,A.COMPANY_ID AS TID
			,A.REG_DT
			FROM 
			company_info A
			LEFT JOIN
			charge_info B
			ON (A.COMPANY_ID=B.COMPANY_ID)
		)J1
		RIGHT JOIN
		msp_charge J2
		ON(J1.TID=J2.COMPANY_ID)
		
		WHERE 1=1
		AND
		(
			( J1.IAAS_NHN    ='Y'
				OR J1.IAAS_NAVER  ='Y'
				OR J1.IAAS_KT     ='Y'
				OR J1.IAAS_AWS    ='Y'
			)
			OR
			 (J1.SDR_NHN     ='Y'
				OR J1.SDR_NAVER   ='Y'
				OR J1.SDR_KT      ='Y'
				)
		)
	</insert>
	
	<delete id="deleteCharge" parameterType="chargeVo">
	    delete from CHARGE_INFO
	</delete>
	
</mapper>